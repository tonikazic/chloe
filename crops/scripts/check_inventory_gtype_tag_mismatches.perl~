#!/usr/bin/perl

# this is ../maize/crops/check_inventory_gtype_tag_mismatches.perl

# We have the new inventory.pl that has scans of the old tags.
#
# We have the file of tags that were generated to replace the bogus ones
# in the seed room, /athe/c/maize/data/reinventory/generate_these_tags
# by ../label_making/make_new_seed_labels.perl.
#
#
#
# We have the file of tags that were replaced,
# /athe/c/maize/data/reinventory/seed_tag_replacemt/28.5/seed_tag_replacemt.csv.
# This is the concatenation of the {24,25,26}.5/seed_tag_replacemt-Table 1.csv.
#
# In that file are multiple cases.
#
# 1. oldma,oldpa = newma, newpa:                                                                 tag replaced for legibility.
# a variety of lines in this category, but also the start of the 11N crop improvement
#
# 2. oldma,nopa  newma,newpa, where oldma = newma:                                               pa supplied
#
# 3. crummy ma, no pa  newma, newpa, where crummy ma is a substring of new ma:                   ma, pa supplied
# crummy ma may be due to scan or manual transcription errors, either way
#
# 4. oldma, oldpa  newma, newpa, where all is the same except family numbers:                    ma, pa replaced with correct families
#
# 5. oldma, oldpa  newma, newpa where mutant newpa still contains inbred letter despite reprint:  don't replace, reprint tags
# these have a string in the last field, "really male XXX"
# 
# 6. oldma, oldpa  newma, newpa where mutant newpa has an inbred family:                         don't replace, reprint tags
# these have a string in the last field, "really male XXX"
# 
# 7. oldma, oldpa  newma, newpa where oldpa is NOT a substring of newpa and mas identical:       don't replace, reprint tags
# these have a string in the last field, "really male XXX" ???
#
# 8. oldma, nopa   newma, newpa where newpa has wrong family:                                    don't replace, reprint tags
# these have a string in the last field, "really male XXX"
#
# 9. oldma, olpa   newma, newpa where newpa completely different due to missing tags:            replace
#
# 10. oldma, oldpa newma, newpa where oldma and newma incorrect:                                 don't replace, reprint tags
# these have a string in the last field, "female really XXX"
#
# 11. oldma, oldpa newma, newpa where newma has correct inbred family:                           replace
# these have a string in the last field, "S/M switch"
#
# 12. all matches but a note in the last field, "no genotype fact":                              replace
#
# 13. oldma, oldpa newma, newpa where oldma is correct and newma false:                          do not replace if correct in new inventory.pl
# extra field says "S/M switch [S,M] correct"
# amend cross, harvest records:  11N row 346 is certainly S, not M
# amend cross, harvest records:  11N row 345 is certainly M, not S
# 
#
#
#
#
#  stopped here fixing baker/braun
#
# check pairs against genotype.pl, old.inventory.pl, harvest.pl, inventory.pl???
#
#
#
# But what all of these cases lead me to think is that we still have a lot to sort out
# in the inventory, that isn't very important right now for building the pedigrees.
# We do have to finish it up, but for example the Baker/Braun corn can wait another year.
#
# So after talking it over, we decided to simply check that each pair of parents in the genotype 
# is present in the replacement file, and if not to spit that out and sort through the output by hand.
#
# This way, if we do see enough consistent cases --- like family shifts --- then we can spit those to
# a file of inventory amendments.
#
# Kazic and Kelly, 29.5.2014


# logic looks correct in early checking.  There are some errors that were introduced in
# replacing the tags that end up in weirdos.
#
# next step after logic verification is to put outputs in a nice form to correct inventory.pl
#
# then to automate the grepping maybe, for the weirdos?  Hand-resolved weirdos can be appended to 
# the file of facts for automated inventory correction.
#
# Kazic, 29.5.2014


use autovivification;


use lib qw(../label_making/);
use Typesetting::MaizeRegEx;
use Typesetting::DefaultOrgztn;


$replcmts_file = '../data/reinventory/seed_tag_replacemt/28.5/seed_tag_replacemt.csv';
$weirdos_file = '../data/reinventory/seed_tag_replacemt/30.5/lingering_weirdos';
$inventory_amendmts_file = '../data/reinventory/seed_tag_replacemt/30.5/inventory_amendmts';

$demeter_dir =~ s/\.\.\///;
$genotype_file = $demeter_dir . "genotype.pl";




open(GEN,"<$genotype_file") or die "can't open genotype file $genotype_file\n";

while (<GEN>) {
        ($gma,$gpa) = $_ =~ /^genotype\(\d+,\d+,\'(${num_gtype_re})\',\d+,\'(${num_gtype_re})\',.+/;
        $gpars{$gma} = $gpa;
        }
close(GEN);








open(WEIRD,">$weirdos_file") or die "can't open weirdos file $weirdos_file\n";
open(AMEND,">$inventory_amendmts_file") or die "can't open replcmts file $inventory_amendmts_file\n";


open(REPLCMTS,"<$replcmts_file") or die "can't open replcmts file $replcmts_file\n";

while (<REPLCMTS>) {
        if ( $_ !~ /^\%/ ) {
                ($oma,$opa,$nma,$npa,$cmt) = $_ =~ /^(${num_gtype_re}),(${num_gtype_re}),(${num_gtype_re}),(${num_gtype_re}),.+,(.+)$/;

                print "$oma x $opa, $nma x $npa :: $cmt\n";

                if ( ( $oma eq $nma ) && ( $opa eq $npa ) && ( exists $gpars{$nma} ) && ( $gpars{$nma} eq $npa ) ) { print "cool beans!\n"; }

                elsif ( ( $oma eq $nma ) && ( $opa eq $npa ) && ( !exists $gpars{$nma} ) ) {
                        print WEIRD "new and old $oma x $opa match, but not in genotype.pl\n";
                        }


                elsif ( ( ( $oma ne $nma ) || ( $opa ne $npa ) ) && ( ( exists $gpars{$oma} ) && ( $gpars{$oma} eq $opa ) ) ) {
                        print WEIRD "mismatch btw new $nma x $npa and genotype, but old $oma x $opa in genotype.pl\n";
                        }





                elsif ( ( ( $oma ne $nma ) || ( $opa ne $npa ) ) && ( ( exists $gpars{$nma} ) && ( $gpars{$nma} eq $npa ) ) ) {
                        print AMEND "new $nma x $npa match genotype.pl, replace in inventory\n";
                        }

	        }
        }
close(REPLCMTS);


close(WEIRD);
close(AMEND);
