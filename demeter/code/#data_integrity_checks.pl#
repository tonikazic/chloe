% this is maize/db/code/data_integrity_checks.pl

% predicates to check stuff
%
% Kazic, 19.4.08


%declarations%

:-      module(data_integrity_checks,[
                check_format/2,
                find_missing/1,
		find_missing/2
                ]).




:-      use_module(genetic_utilities).
      



:-      ensure_loaded(library(basics)),
        ensure_loaded(library(sets)),
        ensure_loaded(library(lists)),
        ensure_loaded(library(strings)).





%end%






check_format(Predicate,File) :-
        ( Predicate == inventory ->
                setof((M,P,S),bad_inventory_fact(M,P,S),L)
	;
	        true
        ),
	output_data(File,L).






% multiple:
%
% * Unbound variable being type-tested
% * Approximate line: 60, file: '/tritogeneia/a/toni/maize/db/code/data_integrity_checks.pl'



bad_inventory_fact(Ma,Pa,Sl) :-
        ( \+ user:inventory(Ma,Pa,cl(C),P,Date,Time,Sl)
        ;
	  bad_num_gtype(Ma)
        ;
	  bad_num_gtype(Pa)
        ;
          ( \+ atom(C) ; memberchk(C,[whole_ear,half_ear,quarter_ear]) ; integer(C) )
        ;
	  \+ atom(P)
        ;
          bad_date(Date)
        ;
          bad_time(Time)
        ;
          \+ atom(Sl)
        ).





bad_num_gtype(NumGtype) :-
        ( \+ atom(NumGtype)
	;
	  deconstruct_plantID(NumGtype,Crop,Family,Row,Plant),
          ( ( midstring(Crop,Year,Season,_,2,1), \+ memberchk(Season,['R','N','G']) )
	  ;
            





bad_date(Date) :-
        (  \+ functor(Date,date,3)
        ;
          ( functor(Date,date,3) ->
                   ( arg(1,Date,M), \+ integer(M) )
                   ;
                     ( arg(2,Date,D), \+ integer(D) )
                   ;
                     ( arg(3,Date,Y), \+ integer(Y) )
                   )
        ).




bad_time(Time) :-
        (  \+ functor(Time,time,3)
        ;
          ( functor(Time,time,3) ->
	          ( arg(1,Time,H), \+ integer(H) )
                  ;
                    ( arg(2,Time,Min), \+ integer(Min) )
                  ;
                    ( arg(3,Time,S), \+ integer(S) )
                  )
        ).








find_missing(File) :-
        setof((Ma,Pa,Sleeve),C^P^D^T^inventory(Ma,Pa,cl(C),P,D,T,Sleeve),Have),
        setof((DMa,DPa,DSleeve),DW^DH^DQ^DC^DP^DD^DT^dup_inv(DMa,DPa,DW,DH,DQ,DC,DP,DD,DT,DSleeve),Extras),
    	find_missing(ma,Have,Extras,MissingMas),
	find_missing(pa,Have,Extras,MissingPas),
	find_missing(blank,Have,Extras,Blanks),
	find_missing(sleeve,Have,Extras,MissingSleeves),
        skipped_sleeves(Have,Skipped),
	output_missing(File,MissingMas,MissingPas,Blanks,MissingSleeves,Skipped).












find_missing(Type,Have,Extras,MissingMas) :-
        find_missing(Type,Have,Extras,[],MissingMas).



find_missing(_,[],_,A,A).
find_missing(Type,[(Ma,Pa,Sleeve)|T],Extras,Acc,Missing) :-
        ( Type == ma ->
                ( ( Ma == '', Pa \== '' ) ->
		        append(Acc,[(Ma,Pa,Sleeve)],NewAcc)
                ;
                        ( memberchk((Ma,_,_),Extras) ->
		                NewAcc = Acc
		        ;
			        append(Acc,[(Ma,Pa,Sleeve)],NewAcc)
		        )
                )
	;
	        ( Type == pa ->
                        ( ( Pa == '', Ma \== '' ) ->
			        append(Acc,[(Ma,Pa,Sleeve)],NewAcc)
                        ;

				( memberchk((_,Pa,_),Extras) ->
			                NewAcc = Acc
			        ;
				        append(Acc,[(Ma,Pa,Sleeve)],NewAcc)
                                )
			)
		;
			( Type == blank ->
			        ( ( Ma == '', Pa == '' ) ->
			                append(Acc,[(Ma,Pa,Sleeve)],NewAcc)
			        ;
				        NewAcc = Acc
			        )
			;
				Type == sleeve,
			        ( memberchk((_,_,Sleeve),Extras) ->
			                NewAcc = Acc
			        ;
				        append(Acc,[Sleeve],NewAcc)
			        )
			)
		)
	),
	find_missing(Type,T,Extras,NewAcc,Missing).








skipped_sleeves(Have,Skipped) :-
        grab_sleeves(Have,Sleeves),
	list_to_set(Sleeves,SleeveSet),
	count_sleeves(SleeveSet,Skipped).




grab_sleeves([],[]).
grab_sleeves([(_,_,S)|T],[S|T2]) :-
        grab_sleeves(T,T2).



count_sleeves(SleeveSet,Skipped) :-
        strip_headers(SleeveSet,Stripped),
        find_missing(Stripped,Skipped).





strip_headers([],[]).
strip_headers([H|T],[S|T2]) :-
        midstring(H,'v',R),
        remove_padding(R,A),
        convert_to_num(A,S),
	strip_headers(T,T2).



find_missing(L,L1) :-
        sort(L,Int),
	find_missing(Int,[],L1).





find_missing([],A,A).
find_missing([_],A,A).
find_missing([H1,H2|T],Acc,Missing) :-
        ( H2 is H1 + 1 ->
	        find_missing([H2|T],Acc,Missing)
	;
	        M is H1 + 1,
		append(Acc,[M],NewAcc),
		find_missing([M,H2|T],NewAcc,Missing)
	).










output_missing(File,MissingMas,MissingPas,Blanks,MissingSleeves,Skipped) :-
	open(File,write,Stream),
	format(Stream,'% mas present in originals not in the consolidated inventory~n~n',[]),
	write_list(Stream,MissingMas),
	format(Stream,'~n~n~n% pas present in originals not in the consolidated inventory~n~n',[]),
	write_list(Stream,MissingPas),
	format(Stream,'~n~n~n% missing parents in the consolidated inventory~n~n',[]),
	write_list(Stream,Blanks),
	format(Stream,'~n~n~n% missing sleeves in the consolidated inventory~n~n',[]),
	write_list(Stream,MissingSleeves),
	format(Stream,'~n~n~n% skipped sleeves in the consolidated inventory~n~n',[]),
	write_list(Stream,Skipped),
	close(Stream).




